name: 24/7 SSH Runner (sshx)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Automatically restarts every 4 hours to match the 240-minute limit
  schedule:
    - cron: '0 */4 * * *' 
  # Allows manual start from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Setting the limit to 240 minutes (4 hours) as requested
    timeout-minutes: 240 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Start SSH and Keep Alive
        run: |
          echo "Starting sshx server..."
          
          # 1. Start sshx in the background using '&'
          # This provides a unique link to access your terminal
          curl -sSf https://sshx.io/get | sh -s run &
          
          # Wait 10 seconds to ensure the link is generated in the logs
          sleep 10
          
          echo "--------------------------------------------------------"
          echo "INSTRUCTIONS:"
          echo "1. Scroll up/down in these logs."
          echo "2. Look for a link like: https://sshx.io/s/XXXXXXXX"
          echo "3. Click the link to open your terminal."
          echo "--------------------------------------------------------"

          # 2. Keep Alive Loop
          # Set for 235 minutes (3 hours 55 mins) to prevent early shutdown
          end=$((SECONDS + 235 * 60))
          
          while [ $SECONDS -lt $end ]; do
            echo "Status: Runner Active | Timestamp: $(date)"
            # Updates logs every 5 minutes
            sleep 300 
          done
          
          echo "Timeout approaching. Gracefully shutting down for the next scheduled job."
